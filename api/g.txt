import { Router } from "express";
import multer from "multer";
import { productCollection } from "../models/indexS.js"; // Adjust according to your structure

// Set up multer for file uploads
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        cb(null, 'uploads/'); // Specify the directory to save the uploaded files
    },
    filename: (req, file, cb) => {
        cb(null, Date.now() + '-' + file.originalname); // Rename the file to avoid conflicts
    }
});

const upload = multer({ storage });

export default ({ config, db }) => {
    let router = Router();

    // POST route for creating a product
    router.post('/product', upload.single('image'), async (req, res) => {
        console.log('Received body:', req.body);
        try {
            const body = req.body;

            if (body.name && req.file) {
                const product = {
                    name: body.name,
                    image: req.file.path // Store the path to the uploaded image
                };

                const newProduct = await productCollection.create(product);

                if (newProduct) {
                    res.status(201).send({ success: true, message: "Product created", product: newProduct });
                } else {
                    res.status(500).send({ success: false, message: "Failed to create product, try again" });
                }
            } else {
                res.status(400).send({ success: false, message: "Please provide a product name and an image" });
            }
        } catch (error) {
            console.error('Error creating product:', error);
            res.status(500).send({ success: false, message: "Internal server error" });
        }
    });

    return router;
}
